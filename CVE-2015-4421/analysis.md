The tzdriver module of Huawei Mate 7 smartphone has an input check error, which allows the user-mode application to modify kernel-mode memory data and elevate privilege.

HWPSIRT-2015-03011:

Attackers can write data into an invalid address to crash the system or elevate their privileges through elaborate applications.


MT7_kernel/drivers/tzdriver/tc_client_driver.c

	static int TC_NS_SMC_Call(TC_NS_ClientContext *client_context, TC_NS_DEV_File *dev_file, bool is_global)
	{
		...        
		for(i = 0; i < 4; i++)
		{
			client_param = &(client_context->params[i]);
			param_type = TEEC_PARAM_TYPE_GET(client_context->paramTypes, i);
			if((param_type == TEEC_VALUE_INPUT)||(param_type == TEEC_VALUE_OUTPUT)||(param_type == TEEC_VALUE_INOUT))
			{
				operation->params[i].value.a = *(u32 *)client_param->value.a_addr;
				operation->params[i].value.b = *(u32 *)client_param->value.b_addr;
			}
		}
		...
		for(i = 0; i < 4; i++)
		{
			client_param = &(client_context->params[i]);
			param_type = TEEC_PARAM_TYPE_GET(client_context->paramTypes, i);
			if((param_type == TEEC_VALUE_OUTPUT)||(param_type == TEEC_VALUE_INOUT))
			{
				//value
				*(u32 *)client_param->value.a_addr = operation->params[i].value.a; //if a_addr or b_addr is kernel memory, then ... oops
				*(u32 *)client_param->value.b_addr = operation->params[i].value.b;
			}
		}
		...
	}
